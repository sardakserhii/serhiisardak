---
import { getEntry } from "astro:content";
import yaml from "js-yaml";

// Fetch CV from GitHub at build time
let cvData;
try {
    const response = await fetch(
        "https://raw.githubusercontent.com/sardakserhii/rendercv/main/Sardak_Serhii_RenderCV.yaml",
    );
    if (!response.ok) throw new Error("Failed to fetch CV");
    const text = await response.text();
    cvData = yaml.load(text);
} catch (e) {
    console.error("Error fetching CV from GitHub, using fallback:", e);
    // Fallback to local import if fetch fails (optional, requires keeping the local file for dev/offline)
    // For now, we'll try to use the raw import as fallback or just fail gracefully
    // To avoid build crash without local network, you might want to mock it.
    // But let's assume valid fetch for now or use the previously created local file as backup:
    const localCV = await import("../data/cv.yaml");
    cvData = localCV.default || localCV;
}

const { cv } = cvData;
---

<section id="cv" class="py-20 bg-[#16181D] text-gray-200">
    <div class="max-w-4xl mx-auto px-4">
        <div class="mb-12 text-center">
            <h2 class="text-3xl md:text-4xl font-bold mb-4 text-[#E3646E]">
                Lebenslauf
            </h2>
            <p class="text-gray-400">
                Live-Daten von GitHub: <a
                    href="https://github.com/sardakserhii/rendercv/blob/main/Sardak_Serhii_RenderCV.yaml"
                    target="_blank"
                    class="underline hover:text-[#E3646E]"
                >
                    sardakserhii/cv.yaml
                </a>
            </p>
        </div>

        <div class="space-y-12">
            <!-- Experience -->
            {
                cv.sections.berufserfahrung && (
                    <div class="relative pl-8 border-l border-[#E3646E]/30 space-y-8">
                        <h3 class="text-2xl font-semibold text-white -ml-8 mb-6 flex items-center">
                            <span class="w-4 h-4 rounded-full bg-[#E3646E] mr-4 inline-block" />
                            Berufserfahrung
                        </h3>
                        {cv.sections.berufserfahrung.map((job) => (
                            <div class="relative group">
                                <div class="absolute -left-[37px] top-1.5 w-3 h-3 rounded-full bg-[#E3646E] border-2 border-[#16181D] group-hover:scale-125 transition-transform" />
                                <div class="mb-1 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                    <h4 class="text-xl font-bold text-white">
                                        {job.position}
                                    </h4>
                                    <span class="text-sm text-[#E3646E] font-medium bg-[#E3646E]/10 px-3 py-1 rounded-full w-fit mt-2 sm:mt-0">
                                        {job.start_date} — {job.end_date}
                                    </span>
                                </div>
                                <p class="text-lg text-gray-300 font-medium mb-3">
                                    {job.company}
                                </p>
                                {job.highlights && (
                                    <ul class="list-disc list-outside ml-4 space-y-1 text-gray-400">
                                        {job.highlights.map((highlight) => (
                                            <li>{highlight}</li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        ))}
                    </div>
                )
            }

            <!-- Education -->
            {
                cv.sections.bildung_und_weiterbildung && (
                    <div class="relative pl-8 border-l border-[#E3646E]/30 space-y-8">
                        <h3 class="text-2xl font-semibold text-white -ml-8 mb-6 flex items-center">
                            <span class="w-4 h-4 rounded-full bg-[#E3646E] mr-4 inline-block" />
                            Ausbildung
                        </h3>
                        {cv.sections.bildung_und_weiterbildung.map((edu) => (
                            <div class="relative group">
                                <div class="absolute -left-[37px] top-1.5 w-3 h-3 rounded-full bg-[#E3646E] border-2 border-[#16181D] group-hover:scale-125 transition-transform" />
                                <div class="mb-1 flex flex-col sm:flex-row sm:items-center sm:justify-between">
                                    <h4 class="text-xl font-bold text-white">
                                        {edu.area}
                                    </h4>
                                    <span class="text-sm text-[#E3646E] font-medium bg-[#E3646E]/10 px-3 py-1 rounded-full w-fit mt-2 sm:mt-0">
                                        {edu.start_date} — {edu.end_date}
                                    </span>
                                </div>
                                <p class="text-lg text-gray-300">
                                    {edu.institution}
                                </p>
                            </div>
                        ))}
                    </div>
                )
            }

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Skills -->
                {
                    cv.sections.edv_kenntnisse && (
                        <div class="bg-gray-800/30 p-6 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <span class="text-[#E3646E] mr-2">❖</span> EDV
                                Kenntnisse
                            </h3>
                            <div class="space-y-4">
                                {cv.sections.edv_kenntnisse.map((skill) => (
                                    <div>
                                        <span class="block text-sm font-semibold text-[#E3646E] uppercase tracking-wider mb-1">
                                            {skill.label}
                                        </span>
                                        <p class="text-gray-300">
                                            {skill.details}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                }

                <!-- Languages -->
                {
                    cv.sections.sprachen && (
                        <div class="bg-gray-800/30 p-6 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                                <span class="text-[#E3646E] mr-2">❖</span>{" "}
                                Sprachen
                            </h3>
                            <div class="space-y-3">
                                {cv.sections.sprachen.map((lang) => (
                                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 last:border-0 last:pb-0">
                                        <span class="text-gray-300 font-medium">
                                            {lang.label}
                                        </span>
                                        <span class="text-[#E3646E]">
                                            {lang.details}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )
                }
            </div>
        </div>
    </div>
</section>
